<html>
  <head>
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>Stock Stalker Import Tool</title>
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.2.0/build/cssreset/reset-min.css">
	<script src="http://yui.yahooapis.com/3.2.0/build/yui/yui-min.js"></script> 
	<script src="js/data.js"></script>
	<script src="js/config.js"></script>
	<script>
		var DEBUG_MODE = true;
	 	window.portsId = [];
	 	window.count = 0;
	 	window.cachedPorts = null;
	 	var Y = new YUI(YUI_Config);
		Y.namespace("Stock");
		function saveLocal(key, obj){
		    // check if the browser supports localStorage
		    if (!window.localStorage){
		        return;
		    }    
		    if (obj == null)
		        localStorage.removeItem(key);
		    if (obj)
		        localStorage.setItem(key, JSON.stringify(obj));
		}
	 	function save(id) {
	        if (id && sample[id]) {
	        	saveLocal("portfolios", sample[id]);
	        	alert("Your info is saved, " + id + "!");
	        }
	        else
	        	alert("Your info is not recognized, " + id + "!");
	    }
	 	function readLocalStorage (key, keyword) {
	 	    if (!window.localStorage){
	 	        return;
	 	    }
	 	    return localStorage.getItem(key);
	 	}
	 	function loadLocal(key, keyword){
	 	    var portfolios, content = readLocalStorage(key, keyword);
	 	    if (content) {
	 	    	portfolios = JSON.parse(content);
	 	    }
	 	    return portfolios;
	 	}
		Y.use("node", "protocol", function(Y) {
			
		 	var pendingTransactions = [];
		 	function runPending() {
		 		if (pendingTransactions.length > 0) {
					var func = pendingTransactions.shift();
					func();
				}
		 	}
		 	function onCmdReceived(resp, action, invokedParams){
		 		Y.one("#Output").append(["<li>", action, "==> response:", JSON.stringify(resp), "</li>"].join(" "));
				if ("addPortfolio" == action) {
					window.portsId[resp.data.pfname] = resp.data.pfid;
					window.count--;
					if (window.count == 0) {
						addTransactions();
					}
				}
				runPending();
			};
			function addTransactions() {
				var sp = Y.Stock.Protocol;
				if (window.cachedPorts) {
					for (i in window.cachedPorts) {
						port = window.cachedPorts[i];
						id = window.portsId[port.name];
						for (j in port.content) {
							lot = port.content[j];
							if (lot.shares > 0 && lot.buy > 0)
								pendingTransactions.push(Y.bind(sp.addStockTransaction, sp, id, lot.symbol, lot.shares, lot.buy, null, lot.note));
						}
						pendingTransactions.push(Y.bind(sp.editCurrentCashBalance, sp, id, port.cash));
						// Migrate history data
						var oldHistoryWeek = localStorage.getItem(port.id + "_week");
						var oldHistoryYear = localStorage.getItem(port.id + "_year");

				        localStorage.removeItem(id + "_week");
				        localStorage.removeItem(id + "_year");
						localStorage.setItem(id + "_week", oldHistoryWeek);
						localStorage.setItem(id + "_year", oldHistoryYear);
						
						
					}
				}
			}
			function createPortfolios() {
				var i, port, migrated = window.localStorage.getItem("migrated"),
	            sp = Y.Stock.Protocol;
				
				if (window.cachedPorts) {
					for (i in window.cachedPorts) {
						port = window.cachedPorts[i];
						window.portsId[port.name] = 0;
						window.count++;
						pendingTransactions.push(Y.bind(sp.addPortfolio, sp, port.name));
					}
				}
			}
			function migrate() {
				Y.one("#import_content").addClass("hidden");
				Y.one("#Output").removeClass("hidden");
				if (!window.cachedPorts)
					window.cachedPorts = loadLocal("portfolios");
				createPortfolios();

				runPending();
	        }
			
			Y.on("CmdResponse", onCmdReceived);
			Y.one("#import").on("click", function(){
				Y.one("#import_content").removeClass("hidden");
				Y.one("#Output").addClass("hidden");
				Y.one("#choices").setContent("");
				var user;
			    for (user in sample) {
			    	Y.one("#choices").append('<button id="' + user + '" onclick="save(\'' + user + '\');">' + user + '</button><br>');
			    }
			});
			Y.one("#migrate").on("click", migrate);
		   	
		    Y.one("#clearsettings").on("click", function(e) {
		    	saveLocal("settings", null);
		    });
		    Y.one("#exportCache").on("click", function(e) {
		    	saveLocal("settings", null);
		    });
		    
		});	
	</script>
	<style>
	button {
		padding: 10px 20px;
	}
	::-webkit-scrollbar {
		width: 14px;
		height: 14px;
	}
	::-webkit-scrollbar-track {
		background: -webkit-gradient(linear,5% 0,95% 0,from(#D5D5D5),to(white));
	}
	::-webkit-scrollbar-thumb {
		border: 1px solid #828282;
		-webkit-border-radius: 13px;
		background: -webkit-gradient(linear,left 0,right 0,from(#B8B8B8),to(#8C8C8C));
		border-top-left-radius: 13px 13px;
		border-top-right-radius: 13px 13px;
		border-bottom-right-radius: 13px 13px;
		border-bottom-left-radius: 13px 13px;
	}
	#choices {
		position: relative;
	}
	#test {
		position: relative;
		height: 306px;
		min-height: 306px;		
		width: 320px;
		overflow: auto;
	}
	#test2 {
		height: 1200px;
	}
	.hidden {
		display: none;
	}
	</style>
  </head>

  <body>
  	<h1>What do you want to do?</h1>
  	<button id="migrate">Migrate your data to server</button><br><br>
  	<div id="Output" class="hidden"></div>
  	<button id="import">Import a set of data</button><br>
  	<div id="import_content" class="hidden">
  		<h1>Which data set would you like to import?</h1>
	  	<div id="choices">
	  	</div>	
 		<button id="clearsettings">Clear Settings</button><br>
 		<button id="exportCache">Export Cache</button><br>
 		<br><br>
 		<textarea id="output"></textarea>
 	</div>	
  </body>
</html>